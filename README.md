# 🌟 Lighting Ultra - 双通道Modbus RTU照明控制系统

## 📋 项目概述

**Lighting Ultra** 是基于STM32F103C8T6的智能照明控制系统，支持双通道Modbus RTU通信和5路继电器输出控制。系统采用模块化设计，具备完整的硬件抽象层，适用于工业照明控制、楼宇自动化等应用场景。

### **🎯 核心特性**

- ✅ **双通道Modbus RTU从设备** - 支持两个独立的RS485通信接口
- ✅ **5路继电器独立控制** - 每路继电器支持独立开关控制
- ✅ **完整的状态反馈** - 实时状态监控和反馈
- ✅ **模块化架构** - 清晰的层次结构，便于扩展和维护
- ✅ **完整的测试框架** - 内置自检和测试功能
- ✅ **详细的文档** - 完整的API文档和使用示例

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    Modbus Master (上位机)                     │
│                  (PC/HMI/PLC/组态软件)                        │
└─────────────────────┬───────────────────────────────────────┘
                      │ RS485 通信
                      │ 波特率: 115200
                      │ 8N1, RTU模式
┌─────────────────────▼───────────────────────────────────────┐
│               STM32F103C8T6 主控制器                        │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │            双通道Modbus RTU协议栈                        │ │
│  │    通道1(UART1)         通道2(UART2)                   │ │
│  │    地址可配置           地址可配置                       │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              Modbus寄存器映射层                          │ │
│  │   寄存器3-7: 继电器控制  (读写)                         │ │
│  │   寄存器8-12: 继电器状态 (只读)                         │ │
│  └─────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │              继电器驱动层                                │ │
│  │   继电器1-5独立控制，状态反馈，批量操作                  │ │
│  └─────────────────────────────────────────────────────────┘ │
└─────────────┬───────────────────────────────┬───────────────┘
              │                               │
    ┌─────────▼─────────┐           ┌─────────▼─────────┐
    │   RS485通信接口    │           │   继电器输出接口   │
    │   485EN1: PA4     │           │   继电器1: PB4    │
    │   485EN2: PA8     │           │   继电器2: PB3    │
    │   UART1: PA9/PA10 │           │   继电器3: PA15   │
    │   UART2: PA2/PA3  │           │   继电器4: PA12   │
    └───────────────────┘           │   继电器5: PA11   │
                                   └───────────────────┘
                                            │
                                   ┌─────────▼─────────┐
                                   │    照明负载        │
                                   │   (灯具/灯带等)    │
                                   └───────────────────┘
```

## 📊 技术规格

### **硬件规格**
| 规格项 | 参数 |
|--------|------|
| **主控芯片** | STM32F103C8T6 |
| **Flash存储** | 64KB |
| **RAM内存** | 20KB |
| **工作电压** | 3.3V |
| **通信接口** | 2路RS485 |
| **继电器输出** | 5路，常开触点 |
| **指示灯** | 电源指示，通信指示 |

### **通信规格**
| 参数 | 值 |
|------|-----|
| **协议标准** | Modbus RTU |
| **波特率** | 115200 bps |
| **数据位** | 8位 |
| **奇偶校验** | 无 |
| **停止位** | 1位 |
| **从设备地址** | 可配置 (1-247) |
| **支持功能码** | 0x03, 0x06, 0x10 |

### **继电器规格**
| 规格项 | 参数 |
|--------|------|
| **继电器数量** | 5路 |
| **触点类型** | 常开(NO) |
| **额定电流** | 10A @250VAC |
| **响应时间** | <10ms |
| **寿命** | >100,000次 |

## 🔌 引脚定义

### **通信引脚**
| 功能 | 引脚 | 说明 |
|------|------|------|
| UART1_TX | PA9 | 通道1发送 |
| UART1_RX | PA10 | 通道1接收 |
| UART2_TX | PA2 | 通道2发送 |
| UART2_RX | PA3 | 通道2接收 |
| 485EN1 | PA4 | 通道1方向控制 |
| 485EN2 | PA8 | 通道2方向控制 |

### **继电器控制引脚**
| 继电器 | 引脚 | 控制寄存器 | 状态寄存器 |
|--------|------|------------|------------|
| 继电器1 | PB4 | 寄存器3 | 寄存器8 |
| 继电器2 | PB3 | 寄存器4 | 寄存器9 |
| 继电器3 | PA15 | 寄存器5 | 寄存器10 |
| 继电器4 | PA12 | 寄存器6 | 寄存器11 |
| 继电器5 | PA11 | 寄存器7 | 寄存器12 |

## 🚀 快速开始

### **1. 硬件连接**
```
STM32F103C8T6开发板:
├── 电源: 3.3V/5V供电
├── RS485接口1: PA9(TX), PA10(RX), PA4(DE/RE)
├── RS485接口2: PA2(TX), PA3(RX), PA8(DE/RE)  
├── 继电器1-5: PB4, PB3, PA15, PA12, PA11
└── 调试接口: PA13(SWDIO), PA14(SWCLK)
```

### **2. 软件编译**
```bash
1. 打开Keil MDK-ARM
2. 加载项目: lighting_ultra.uvprojx
3. 选择目标: STM32F103C8T6
4. 编译项目: Build (F7)
5. 下载程序: Download (F8)
```

### **3. 功能测试**
```c
// 启用自检功能 (在编译选项中添加)
#define ENABLE_RELAY_SELFTEST

// 系统会在启动时自动进行继电器自检
// 每个继电器会依次开启500ms然后关闭
```

## 📡 Modbus使用示例

### **Python控制示例**
```python
from pymodbus.client.sync import ModbusSerialClient

# 连接设备
client = ModbusSerialClient(method='rtu', port='COM3', baudrate=115200)
client.connect()

# 开启继电器1
client.write_register(3, 1, unit=1)

# 读取继电器1状态
result = client.read_holding_registers(8, 1, unit=1)
status = result.registers[0]
print(f"继电器1状态: {'开启' if status else '关闭'}")

# 批量控制 - 开启继电器1,3,5
client.write_registers(3, [1, 0, 1, 0, 1], unit=1)

client.close()
```

### **组态软件配置**
```
设备类型: Modbus RTU
从站地址: 1
波特率: 115200
数据位: 8, 奇偶校验: 无, 停止位: 1

变量定义:
- 继电器1控制: 40004 (寄存器3+1)
- 继电器1状态: 40009 (寄存器8+1)
...
```

## 🧪 测试功能

### **内置测试函数**
```c
// 系统自检
bool result = relaySystemSelfTest();

// 流水灯测试
relayRunningLightTest(500, 3); // 500ms延时, 3个循环

// 同步闪烁测试  
relaySyncFlashTest(5, 1000, 1000); // 5次闪烁, 开启1s, 关闭1s

// 响应时间测试
uint32_t responseTime = relayResponseTimeTest(RELAY_CHANNEL_FIRST, 10);
```

### **测试报告**
```
========== 继电器测试报告 ==========
总测试数: 5
通过数: 5  
失败数: 0
通过率: 100.0%

详细结果:
继电器1 (PB4): 通过
继电器2 (PB3): 通过
继电器3 (PA15): 通过
继电器4 (PA12): 通过
继电器5 (PA11): 通过
=====================================
```

## 📁 项目结构

```
lighting_ultra/
├── Core/
│   ├── Inc/                    # 头文件目录
│   │   ├── main.h              # 主程序头文件
│   │   ├── relay.h             # 继电器驱动头文件
│   │   ├── relay_test.h        # 继电器测试头文件
│   │   ├── app_modbus.h        # Modbus应用头文件
│   │   ├── modbus_slave.h      # Modbus协议栈头文件
│   │   ├── modbus_hal.h        # Modbus硬件抽象头文件
│   │   └── modbus_config.h     # Modbus配置头文件
│   ├── Src/                    # 源代码目录
│   │   ├── main.c              # 主程序
│   │   ├── relay.c             # 继电器驱动实现
│   │   ├── relay_test.c        # 继电器测试实现
│   │   ├── app_modbus.c        # Modbus应用层实现
│   │   ├── modbus_slave.c      # Modbus协议栈实现
│   │   └── modbus_hal.c        # Modbus硬件抽象实现
│   └── Doc/                    # 文档目录
│       └── ModbusRegisterMap.md # Modbus寄存器映射文档
├── Drivers/                    # 驱动库目录
│   ├── STM32F1xx_HAL_Driver/   # STM32 HAL库
│   └── CMSIS/                  # CMSIS库
├── MDK-ARM/                    # Keil项目文件
│   ├── lighting_ultra.uvprojx  # Keil项目文件
│   └── startup_stm32f103c8tx.s # 启动文件
└── README.md                   # 项目说明文档
```

## 🔧 开发指南

### **添加新功能**
1. **扩展寄存器映射**: 在`modbus_config.h`中添加新的寄存器定义
2. **更新回调函数**: 在`app_modbus.c`中处理新的寄存器逻辑
3. **添加驱动模块**: 创建新的驱动文件，遵循现有的模块化结构
4. **更新测试**: 在`relay_test.c`中添加相应的测试函数

### **移植到其他STM32芯片**
1. 修改`lighting_ultra.ioc`配置文件
2. 更新启动文件和链接脚本  
3. 调整内存配置(`modbus_config.h`)
4. 重新生成HAL初始化代码

### **调试技巧**
1. 使用Modbus调试工具验证通信
2. 启用系统自检功能验证硬件
3. 使用示波器检查继电器响应时间
4. 通过UART输出调试信息

## 🛡️ 安全注意事项

⚠️ **电气安全**
- 继电器触点额定电流：10A @250VAC
- 禁止超过额定参数使用
- 接线时务必断电操作

⚠️ **软件安全**  
- 系统看门狗保护，防止程序死锁
- 继电器状态反馈，确保控制有效性
- Modbus异常处理，防止非法操作

## 📞 技术支持

- **项目仓库**: [GitHub链接]
- **技术文档**: `/Core/Doc/`目录
- **问题反馈**: 通过Issue报告问题
- **开发团队**: Lighting Ultra Team

## 📄 版本历史

### **v2.0.0** (2025-01-20)
- ✨ 添加独立继电器控制功能
- ✨ 实现新的Modbus寄存器映射(3-7控制，8-12状态)
- ✨ 添加完整的测试框架
- ✨ 创建详细的使用文档
- 🐛 修复STM32F103C8T6编译问题

### **v1.0.0** (2025-01-19) 
- 🎉 初始版本发布
- ✨ 双通道Modbus RTU通信
- ✨ 基础继电器控制功能
- ✨ 模块化架构设计

---

## 📜 许可证

本项目基于MIT许可证开源，详情请参阅LICENSE文件。

**© 2025 Lighting Ultra Team. All Rights Reserved.**
