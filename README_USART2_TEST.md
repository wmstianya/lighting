# USART2 串口回环测试说明

## 功能描述

本测试程序用于验证 **USART2（串口1）** 的完整收发功能：
- 通过 DMA 接收数据
- 打印接收数据的 HEX 和 ASCII 格式
- 原样回发接收到的数据

## 硬件连接

| 引脚 | 功能 | 说明 |
|------|------|------|
| PA2  | USART2_TX | 串口发送 |
| PA3  | USART2_RX | 串口接收 |
| PA4  | RS485_DE  | RS485 收发控制 (高=发送, 低=接收) |

## 测试方式

### 1. 编译配置

确保 `main.c` 中的宏定义：
```c
#define RUN_MODE_ECHO_TEST 1  // 1=回环测试, 0=Modbus模式
```

确保 `stm32f1xx_it.c` 中的宏定义：
```c
#define USART2_TEST_MODE 1    // 1=Echo测试, 0=Modbus模式
```

### 2. 测试步骤

#### 方式A：短接回环测试（硬件自环）
1. 将 **PA2 和 PA3 短接**（TX 和 RX 短接）
2. 烧录程序到 STM32
3. 打开串口助手（波特率 9600, 8N1）
4. 连接到 USART2（PA2/PA3）
5. 发送任意数据，观察回显

**预期输出示例**：
```
=== USART2 Echo Test Started ===

[RX] 11 bytes: 48 65 6C 6C 6F 20 57 6F 72 6C 64 
[ASCII]: Hello World

[TX] Echo back: Hello World
[OK] Echo sent!
```

#### 方式B：双机通信测试
1. 使用 USB 转 TTL 模块连接 PA2/PA3
2. 通过串口助手发送数据
3. 观察设备回环响应

### 3. 数据流程

```
接收数据（DMA）
    ↓
IDLE 中断触发
    ↓
计算接收字节数
    ↓
打印 HEX 格式数据
    ↓
打印 ASCII 格式
    ↓
RS485 切换到发送模式
    ↓
DMA 发送数据
    ↓
RS485 切换回接收模式
    ↓
重启 DMA 接收
```

## 测试结果判断

### 成功标志
- ✅ 串口助手能收到启动提示信息
- ✅ 发送数据后能看到 HEX 和 ASCII 打印
- ✅ 接收到回环数据且内容完全一致

### 失败排查
- ❌ 无任何输出 → 检查串口连接和波特率配置
- ❌ 有打印但无回环 → 检查 RS485 使能引脚控制
- ❌ 数据错乱 → 检查 DMA 配置和时序

## 切换回 Modbus 模式

修改宏定义为：
```c
// main.c
#define RUN_MODE_ECHO_TEST 0

// stm32f1xx_it.c  
#define USART2_TEST_MODE 0
```

重新编译烧录即可。

## 测试输出格式说明

| 输出项 | 说明 | 示例 |
|--------|------|------|
| `[RX] N bytes:` | 接收字节数 | `[RX] 5 bytes:` |
| `HEX 数据` | 十六进制格式 | `41 42 43 44 45` |
| `[ASCII]:` | ASCII 可见字符 | `ABCDE` |
| `[TX] Echo back:` | 回发数据标记 | - |
| `[OK] Echo sent!` | 发送完成 | - |

## 性能参数

- **波特率**: 9600 bps
- **缓冲区大小**: 256 字节
- **最大单次接收**: 256 字节
- **IDLE 超时**: 约 1.15 ms (9600 bps, 11 位/字节)
- **RS485 切换延时**: 2 ms

## 注意事项

1. 测试模式下不执行 Modbus 协议处理
2. RS485 模式需要正确配置 DE 引脚
3. 长时间运行需注意缓冲区不会溢出（已有大小检查）
4. 发送完成后必须切换回接收模式，否则无法继续接收

---
**作者**: Lighting Ultra Team  
**日期**: 2025-11-05  
**版本**: 1.0.0

