# 模块化Modbus RTU测试指南

## 1. 测试环境配置

### 硬件连接
- **UART1 (PA9/PA10)**: 
  - PA9 (TX) -> RS485转换器 DI
  - PA10 (RX) -> RS485转换器 RO
  - PA4 -> RS485转换器 DE/RE
  - 从站地址: 0x01

- **UART2 (PA2/PA3)**:
  - PA2 (TX) -> RS485转换器 DI
  - PA3 (RX) -> RS485转换器 RO
  - PA4 -> RS485转换器 DE/RE (共用)
  - 从站地址: 0x02

### 通信参数
- 波特率: 115200 bps
- 数据位: 8
- 停止位: 1
- 校验: 无

## 2. 功能测试

### 2.1 UART1测试（从站地址0x01）

#### 读保持寄存器（功能码03）
```
请求: 01 03 00 00 00 0A C5 CD
响应: 01 03 14 03 E8 03 E9 03 EA 03 EB 03 EC 03 ED 03 EE 03 EF 03 F0 03 F1 XX XX
```
说明: 读取地址0开始的10个寄存器，返回值为1000-1009

#### 写单个寄存器（功能码06）
```
请求: 01 06 00 00 12 34 8D 4F
响应: 01 06 00 00 12 34 8D 4F
```
说明: 将地址0的寄存器写入0x1234

#### 读线圈（功能码01）
```
请求: 01 01 00 00 00 10 3D C6
响应: 01 01 02 FF 00 XX XX
```
说明: 读取前16个线圈，前8个为ON(0xFF)，后8个为OFF(0x00)

#### 写单个线圈（功能码05）
```
请求: 01 05 00 08 FF 00 8C 3A
响应: 01 05 00 08 FF 00 8C 3A
```
说明: 将地址8的线圈设置为ON

### 2.2 UART2测试（从站地址0x02）

#### 读保持寄存器（功能码03）
```
请求: 02 03 00 00 00 05 85 FA
响应: 02 03 0A 07 D0 07 D1 07 D2 07 D3 07 D4 XX XX
```
说明: 读取地址0开始的5个寄存器，返回值为2000-2004

#### 读输入寄存器（功能码04）
```
请求: 02 04 00 00 00 05 31 FA
响应: 02 04 0A 09 C4 09 C5 09 C6 09 C7 09 C8 XX XX
```
说明: 读取地址0开始的5个输入寄存器，返回值为2500-2504

## 3. LED指示灯说明

- **PB1 (LED)**: Modbus活动指示
  - 快闪: 接收到有效帧
  - 慢闪: 系统运行心跳
  - 常亮: 发送响应中

## 4. 数据更新机制

系统每秒自动更新一次传感器数据：
- UART1输入寄存器: 随机温度值（20-30°C）
- UART2输入寄存器: 随机湿度值（40-60%）

## 5. 回调函数测试

### 线圈变化回调
当线圈0被写入时，会自动控制继电器：
- 线圈0 = ON: 继电器1闭合
- 线圈0 = OFF: 继电器1断开

### 寄存器变化回调
当保持寄存器0被写入时：
- 值 > 1500: LED快闪3次
- 值 ≤ 1500: LED慢闪1次

## 6. 故障诊断

### 无响应
1. 检查从站地址是否正确
2. 检查波特率设置（115200）
3. 确认RS485方向控制引脚（PA4）
4. 验证DMA是否正确配置

### CRC错误
1. 确认通信参数一致
2. 检查RS485总线终端电阻
3. 降低波特率测试

### 响应延迟
1. 检查中断优先级设置
2. 确认IDLE中断正确触发
3. 验证DMA传输完成回调

## 7. 性能指标

- 最大响应时间: < 10ms
- 支持的最大寄存器数量: 100个保持寄存器，50个输入寄存器
- 支持的最大线圈数量: 80个
- 支持的离散输入数量: 40个
- 并发处理: 支持两个串口同时工作

## 8. 调试建议

1. 使用串口调试助手发送测试命令
2. 使用逻辑分析仪监控RS485总线
3. 启用LED调试指示
4. 查看统计信息（通过调试器查看ModbusStats结构）

## 9. 扩展应用

### 添加更多串口
1. 复制`modbus_port_uart1.c`为新文件
2. 修改UART句柄和引脚配置
3. 在`modbus_app.c`中添加新实例
4. 更新中断处理函数

### 自定义数据映射
1. 修改`modbus_app.c`中的数据存储数组
2. 实现自定义回调函数
3. 更新寄存器映射关系

### 集成到其他系统
1. 调用`ModbusApp_GetUart1Instance()`获取实例
2. 使用`ModbusRTU_ReadHoldingReg()`等API访问数据
3. 通过回调函数实现事件驱动
