# 🔄 UART回环测试指南

## 🎯 测试目的

**验证UART+DMA+RS485硬件功能**，绕过复杂的Modbus协议处理，直接测试底层通信是否正常。

## 🔧 启用回环测试模式

### 方法1：使用编译开关（推荐）

1. **打开main.c文件**
2. **找到第28行**：`// #define ENABLE_UART_LOOPBACK_TEST`
3. **取消注释**：改为 `#define ENABLE_UART_LOOPBACK_TEST`
4. **重新编译烧录**

### 方法2：临时替换主程序（完全独立测试）

1. **在Keil项目中**：
   - 右键`main.c` → Remove from Group
   - 右键`Application/User/Core` → Add Existing Files
   - 选择`main_loopback_test.c`
2. **编译烧录**
3. **测试完成后记得改回来！**

## 🧪 测试步骤

### 第一步：观察启动指示

烧录完成后观察继电器状态：

| 继电器 | 引脚 | 指示含义 |
|--------|------|----------|
| **继电器1** | PB4 | 快速闪烁5次 → 回环测试模式启动 |
| **继电器2** | PB3 | 长亮 → 回环测试就绪，等待数据 |

### 第二步：硬件连接确认

```
STM32F103C8T6 ↔ RS485模块 ↔ USB转RS485 ↔ PC

连接检查：
├── PA9 (UART1_TX) → RS485_A+
├── PA10 (UART1_RX) → RS485_B-  
├── PA4 (485EN1) → RS485_DE/RE
├── 3.3V → RS485_VCC
└── GND → RS485_GND
```

### 第三步：使用串口助手测试

#### 配置串口助手
```
端口：COM? (您的USB转RS485端口)
波特率：115200
数据位：8
奇偶校验：无
停止位：1
```

#### 发送测试数据
```
十六进制发送：
01 02 03 04 05

ASCII发送：
Hello STM32!

任意数据：
AA BB CC DD EE FF
```

#### 期望结果
```
发送: 01 02 03 04 05
接收: 01 02 03 04 05 (完全相同的数据返回)

发送: Hello STM32!  
接收: Hello STM32! (完全相同的字符串返回)
```

### 第四步：观察继电器指示

测试过程中观察继电器状态：

| 动作 | 继电器指示 | 含义 |
|------|------------|------|
| **发送数据** | 继电器3闪烁20ms | STM32收到数据 |
| **数据处理** | 处理中... | 数据复制和RS485切换 |
| **发送完成** | 继电器4闪烁20ms | 回环数据发送完成 |
| **每10次** | 继电器5闪烁100ms | 统计指示 |

## 📊 测试结果判断

### ✅ 成功的标志
- 发送任意数据都能收到**完全相同**的返回数据
- 继电器指示灯按预期闪烁
- 数据传输稳定，无丢失

### ❌ 失败的情况及诊断

#### 情况1：没有任何返回数据
**可能原因**：
- RS485连接错误（A+/B-接反）
- 485EN引脚(PA4)没有连接到DE/RE
- 供电问题

**验证方法**：
- 用万用表测试PA4引脚：发送时应该有高电平
- 检查RS485模块指示灯
- 验证供电电压

#### 情况2：返回数据不完整或错误
**可能原因**：
- DMA配置问题
- 时序问题
- RS485方向切换不稳定

**解决方法**：
- 增加延时时间
- 检查DMA通道配置
- 验证UART参数设置

#### 情况3：继电器不闪烁
**可能原因**：
- GPIO初始化失败
- 程序没有正确运行
- 系统死锁

**解决方法**：
- 检查编译是否成功
- 验证烧录是否完整
- 检查看门狗配置

## 🛠️ 常用测试命令

### 十六进制测试
```
简单测试：01 02 03
Modbus格式：01 03 00 08 00 01 04 08
长数据：01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F 10
```

### ASCII测试
```
简短：OK
中等：Hello World
长文本：This is a long message for testing UART loopback functionality!
```

### 压力测试
```
连续发送多条不同长度的数据
观察是否都能正确返回
检查统计计数是否正确递增
```

## 🔄 切换回正常模式

### 使用编译开关的用户
1. **注释掉** `#define ENABLE_UART_LOOPBACK_TEST`
2. **重新编译烧录**

### 使用临时文件的用户  
1. **在Keil中移除** `main_loopback_test.c`
2. **重新添加** 原来的`main.c`
3. **重新编译烧录**

## 📋 故障排查清单

- [ ] 继电器1启动时是否闪烁5次？
- [ ] 继电器2是否长亮？
- [ ] 发送数据时继电器3是否闪烁？
- [ ] RS485 A+/B-是否接线正确？
- [ ] PA4是否连接到RS485的DE/RE？
- [ ] 供电是否正常？
- [ ] 串口助手配置是否正确？

---

**通过这个回环测试，您可以100%确认UART+DMA+RS485硬件功能是否正常！**

**如果回环测试成功，说明硬件完全正常，问题在Modbus协议处理层面。**
**如果回环测试失败，说明硬件连接或配置有问题，需要先解决硬件问题。**

