# Modbuså¯„å­˜å™¨æ˜ å°„è¯´æ˜æ–‡æ¡£

## ğŸ“‹ å¯„å­˜å™¨åœ°å€åˆ†é…

### **ç³»ç»Ÿæ¦‚è§ˆ**
- **è®¾å¤‡ç±»å‹**: åŒé€šé“Modbus RTUä»è®¾å¤‡
- **ä»è®¾å¤‡åœ°å€**: å¯é…ç½® (é»˜è®¤1å’Œ2)  
- **æ³¢ç‰¹ç‡**: 115200 bps
- **æ•°æ®ä½**: 8ä½ï¼Œæ— å¥‡å¶æ ¡éªŒï¼Œ1ä¸ªåœæ­¢ä½

### **ğŸ“Š å¯„å­˜å™¨æ˜ å°„è¡¨**

| å¯„å­˜å™¨åœ°å€ | åŠŸèƒ½æè¿° | æ•°æ®ç±»å‹ | æƒé™ | å¤‡æ³¨ |
|------------|----------|----------|------|------|
| **0-2** | ç³»ç»Ÿé¢„ç•™åŒºåŸŸ | uint16_t | è¯»/å†™ | é¢„ç•™ç»™ç³»ç»Ÿæ‰©å±• |
| **3** | ç»§ç”µå™¨1æ§åˆ¶ | uint16_t | è¯»/å†™ | 0=å…³é—­, é0=å¼€å¯ |
| **4** | ç»§ç”µå™¨2æ§åˆ¶ | uint16_t | è¯»/å†™ | 0=å…³é—­, é0=å¼€å¯ |
| **5** | ç»§ç”µå™¨3æ§åˆ¶ | uint16_t | è¯»/å†™ | 0=å…³é—­, é0=å¼€å¯ |
| **6** | ç»§ç”µå™¨4æ§åˆ¶ | uint16_t | è¯»/å†™ | 0=å…³é—­, é0=å¼€å¯ |
| **7** | ç»§ç”µå™¨5æ§åˆ¶ | uint16_t | è¯»/å†™ | 0=å…³é—­, é0=å¼€å¯ |
| **8** | ç»§ç”µå™¨1çŠ¶æ€åé¦ˆ | uint16_t | **åªè¯»** | å®æ—¶çŠ¶æ€ 0=å…³é—­, 1=å¼€å¯ |
| **9** | ç»§ç”µå™¨2çŠ¶æ€åé¦ˆ | uint16_t | **åªè¯»** | å®æ—¶çŠ¶æ€ 0=å…³é—­, 1=å¼€å¯ |
| **10** | ç»§ç”µå™¨3çŠ¶æ€åé¦ˆ | uint16_t | **åªè¯»** | å®æ—¶çŠ¶æ€ 0=å…³é—­, 1=å¼€å¯ |
| **11** | ç»§ç”µå™¨4çŠ¶æ€åé¦ˆ | uint16_t | **åªè¯»** | å®æ—¶çŠ¶æ€ 0=å…³é—­, 1=å¼€å¯ |
| **12** | ç»§ç”µå™¨5çŠ¶æ€åé¦ˆ | uint16_t | **åªè¯»** | å®æ—¶çŠ¶æ€ 0=å…³é—­, 1=å¼€å¯ |
| **13-63** | ç³»ç»Ÿæ‰©å±•åŒºåŸŸ | uint16_t | è¯»/å†™ | é¢„ç•™ç»™æœªæ¥åŠŸèƒ½ |

### **ğŸ”Œ ç»§ç”µå™¨ç¡¬ä»¶æ˜ å°„**

| ç»§ç”µå™¨ç¼–å· | æ§åˆ¶å¼•è„š | æ§åˆ¶å¯„å­˜å™¨ | çŠ¶æ€å¯„å­˜å™¨ | åŠŸèƒ½è¯´æ˜ |
|------------|----------|------------|------------|----------|
| **ç»§ç”µå™¨1** | PB4 | å¯„å­˜å™¨3 | å¯„å­˜å™¨8 | ç…§æ˜å›è·¯1 |
| **ç»§ç”µå™¨2** | PB3 | å¯„å­˜å™¨4 | å¯„å­˜å™¨9 | ç…§æ˜å›è·¯2 |
| **ç»§ç”µå™¨3** | PA15 | å¯„å­˜å™¨5 | å¯„å­˜å™¨10 | ç…§æ˜å›è·¯3 |
| **ç»§ç”µå™¨4** | PA12 | å¯„å­˜å™¨6 | å¯„å­˜å™¨11 | ç…§æ˜å›è·¯4 |
| **ç»§ç”µå™¨5** | PA11 | å¯„å­˜å™¨7 | å¯„å­˜å™¨12 | ç…§æ˜å›è·¯5 |

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### **1. Python + pymodbus ç¤ºä¾‹**

```python
from pymodbus.client.sync import ModbusSerialClient

# è¿æ¥Modbusè®¾å¤‡
client = ModbusSerialClient(
    method='rtu', 
    port='COM3',        # æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
    baudrate=115200,
    bytesize=8,
    parity='N',
    stopbits=1,
    timeout=1
)

client.connect()

# ç¤ºä¾‹1ï¼šå•ç‹¬æ§åˆ¶ç»§ç”µå™¨
def control_single_relay(relay_num, state):
    """
    æ§åˆ¶å•ä¸ªç»§ç”µå™¨
    relay_num: 1-5 (ç»§ç”µå™¨ç¼–å·)
    state: True=å¼€å¯, False=å…³é—­
    """
    reg_addr = 2 + relay_num  # å¯„å­˜å™¨3-7
    value = 1 if state else 0
    
    result = client.write_register(reg_addr, value, unit=1)
    if result.isError():
        print(f"æ§åˆ¶ç»§ç”µå™¨{relay_num}å¤±è´¥")
    else:
        print(f"ç»§ç”µå™¨{relay_num} {'å¼€å¯' if state else 'å…³é—­'}æˆåŠŸ")

# ç¤ºä¾‹2ï¼šè¯»å–ç»§ç”µå™¨çŠ¶æ€
def read_relay_status(relay_num):
    """
    è¯»å–å•ä¸ªç»§ç”µå™¨çŠ¶æ€
    relay_num: 1-5 (ç»§ç”µå™¨ç¼–å·)
    """
    reg_addr = 7 + relay_num  # å¯„å­˜å™¨8-12
    result = client.read_holding_registers(reg_addr, 1, unit=1)
    
    if result.isError():
        print(f"è¯»å–ç»§ç”µå™¨{relay_num}çŠ¶æ€å¤±è´¥")
        return None
    else:
        state = result.registers[0]
        print(f"ç»§ç”µå™¨{relay_num}çŠ¶æ€: {'å¼€å¯' if state else 'å…³é—­'}")
        return state

# ç¤ºä¾‹3ï¼šæ‰¹é‡æ§åˆ¶
def batch_control_relays(states):
    """
    æ‰¹é‡æ§åˆ¶ç»§ç”µå™¨
    states: [ç»§ç”µå™¨1çŠ¶æ€, ç»§ç”µå™¨2çŠ¶æ€, ..., ç»§ç”µå™¨5çŠ¶æ€]
    """
    values = [1 if state else 0 for state in states]
    result = client.write_registers(3, values, unit=1)
    
    if result.isError():
        print("æ‰¹é‡æ§åˆ¶å¤±è´¥")
    else:
        print("æ‰¹é‡æ§åˆ¶æˆåŠŸ")

# ä½¿ç”¨ç¤ºä¾‹
control_single_relay(1, True)   # å¼€å¯ç»§ç”µå™¨1
control_single_relay(3, False)  # å…³é—­ç»§ç”µå™¨3

read_relay_status(1)            # è¯»å–ç»§ç”µå™¨1çŠ¶æ€

# å¼€å¯ç»§ç”µå™¨1,3,5ï¼Œå…³é—­ç»§ç”µå™¨2,4
batch_control_relays([True, False, True, False, True])

client.close()
```

### **2. Cè¯­è¨€ç¤ºä¾‹ï¼ˆå…¶ä»–MCUä½œä¸ºä¸»æœºï¼‰**

```c
#include "modbus_master.h"  // å‡è®¾ä½ æœ‰Modbusä¸»æœºåº“

// æ§åˆ¶å•ä¸ªç»§ç”µå™¨
HAL_StatusTypeDef controlRelay(uint8_t relayNum, bool state) {
    uint16_t regAddr = 2 + relayNum;  // å¯„å­˜å™¨3-7
    uint16_t value = state ? 1 : 0;
    
    return modbus_write_single_register(1, regAddr, value);  // ä»è®¾å¤‡åœ°å€1
}

// è¯»å–ç»§ç”µå™¨çŠ¶æ€
HAL_StatusTypeDef readRelayStatus(uint8_t relayNum, bool* status) {
    uint16_t regAddr = 7 + relayNum;  // å¯„å­˜å™¨8-12
    uint16_t value;
    
    HAL_StatusTypeDef result = modbus_read_holding_registers(1, regAddr, 1, &value);
    if (result == HAL_OK) {
        *status = (value != 0);
    }
    return result;
}

// ä½¿ç”¨ç¤ºä¾‹
bool status;
controlRelay(1, true);         // å¼€å¯ç»§ç”µå™¨1
readRelayStatus(1, &status);   // è¯»å–ç»§ç”µå™¨1çŠ¶æ€
```

### **3. ç»„æ€è½¯ä»¶é…ç½®ç¤ºä¾‹**

#### **MCGS/ç»„æ€ç‹é…ç½®**
```
è®¾å¤‡ç±»å‹: Modbus RTU
ä»ç«™åœ°å€: 1
å¯„å­˜å™¨ç±»å‹: ä¿æŒå¯„å­˜å™¨ (Holding Register)

å˜é‡å®šä¹‰:
- ç»§ç”µå™¨1_æ§åˆ¶: åœ°å€40004 (å¯„å­˜å™¨3+1)
- ç»§ç”µå™¨1_çŠ¶æ€: åœ°å€40009 (å¯„å­˜å™¨8+1) 
- ç»§ç”µå™¨2_æ§åˆ¶: åœ°å€40005 (å¯„å­˜å™¨4+1)
- ç»§ç”µå™¨2_çŠ¶æ€: åœ°å€40010 (å¯„å­˜å™¨9+1)
...ä»¥æ­¤ç±»æ¨
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### **1. å¯„å­˜å™¨ç‰¹æ€§**
- **æ§åˆ¶å¯„å­˜å™¨(3-7)**: æ”¯æŒè¯»å†™ï¼Œå†™å…¥0å…³é—­ç»§ç”µå™¨ï¼Œå†™å…¥é0å¼€å¯ç»§ç”µå™¨
- **çŠ¶æ€å¯„å­˜å™¨(8-12)**: åªè¯»ï¼Œè¿”å›ç»§ç”µå™¨å®é™…çŠ¶æ€ï¼Œå°è¯•å†™å…¥ä¼šè¿”å›å¼‚å¸¸

### **2. å¼‚å¸¸å¤„ç†**
- **0x02 (ILLEGAL_DATA_ADDRESS)**: å°è¯•å†™å…¥åªè¯»çš„çŠ¶æ€å¯„å­˜å™¨
- **0x03 (ILLEGAL_DATA_VALUE)**: ç»§ç”µå™¨æ§åˆ¶æ“ä½œå¤±è´¥

### **3. å»ºè®®ä½¿ç”¨æ–¹æ³•**
1. **æ§åˆ¶ç»§ç”µå™¨**: å†™å…¥æ§åˆ¶å¯„å­˜å™¨ (3-7)
2. **ç¡®è®¤çŠ¶æ€**: è¯»å–çŠ¶æ€å¯„å­˜å™¨ (8-12) éªŒè¯æ“ä½œæ˜¯å¦æˆåŠŸ
3. **æ•…éšœè¯Šæ–­**: å¦‚æœæ§åˆ¶å¯„å­˜å™¨å†™å…¥æˆåŠŸä½†çŠ¶æ€å¯„å­˜å™¨æ˜¾ç¤ºä¸ä¸€è‡´ï¼Œå¯èƒ½å­˜åœ¨ç¡¬ä»¶æ•…éšœ

### **4. é€šä¿¡å‚æ•°**
- **ä»è®¾å¤‡åœ°å€**: é€šé“1å’Œé€šé“2å¯ä»¥è®¾ç½®ä¸åŒçš„ä»è®¾å¤‡åœ°å€
- **è¶…æ—¶è®¾ç½®**: å»ºè®®è®¾ç½®è‡³å°‘100msçš„é€šä¿¡è¶…æ—¶
- **é‡è¯•æœºåˆ¶**: å»ºè®®å®ç°è‡ªåŠ¨é‡è¯•æœºåˆ¶ï¼Œæœ€å¤šé‡è¯•3æ¬¡

## ğŸ”§ è°ƒè¯•å·¥å…·æ¨è

1. **Modbus Poll**: Windowsä¸‹çš„Modbusè°ƒè¯•å·¥å…·
2. **pymodbus**: Pythonå‘½ä»¤è¡Œè°ƒè¯•
3. **ModbusMaster**: Androidæ‰‹æœºç«¯è°ƒè¯•å·¥å…·
4. **ä¸²å£åŠ©æ‰‹**: æŸ¥çœ‹åŸå§‹é€šä¿¡æ•°æ®

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0.0  
**æ›´æ–°æ—¥æœŸ**: 2025-01-20  
**é€‚ç”¨å›ºä»¶**: lighting_ultra v2.0.0+
