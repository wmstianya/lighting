# STM32F103C8T6 平台注意事项

## 芯片规格

| 参数 | STM32F103C8T6 | STM32F103VCT6 (之前误用) |
|------|--------------|-------------------------|
| **Flash** | **64KB** | 256KB |
| **RAM** | **20KB** | 48KB |
| **页数** | **32页** | 128页 |
| **封装** | **LQFP48** | LQFP100 |
| **IO数** | **37个** | 80个 |

## ⚠️ Flash地址修正

### 错误配置（已修复）
```c
// ❌ 这是256KB芯片的地址，C8T6访问会HardFault！
#define CONFIG_FLASH_BASE_ADDR      0x0803F800  
#define ERROR_LOG_FLASH_BASE_ADDR   0x0803F000
```

### 正确配置（当前使用）
```c
// ✓ C8T6的正确地址
#define CONFIG_FLASH_BASE_ADDR      0x0800F800  // 最后一页
#define ERROR_LOG_FLASH_BASE_ADDR   0x0800F000  // 倒数第二页
```

## Flash分区详情

```
STM32F103C8T6 Flash布局：
┌──────────────────────────────────────┐
│ Page 0  │ 0x08000000 - 0x080007FF │ 程序区开始
│ Page 1  │ 0x08000800 - 0x08000FFF │
│ ...     │ ...                     │
│ Page 29 │ 0x0800E800 - 0x0800EFFF │ 程序区结束（约60KB）
├──────────────────────────────────────┤
│ Page 30 │ 0x0800F000 - 0x0800F7FF │ 错误日志区（2KB）
│         │ - 62条日志 × 32字节     │
├──────────────────────────────────────┤
│ Page 31 │ 0x0800F800 - 0x0800FFFF │ 系统配置区（2KB）
│         │ - SystemConfig_t        │
│         │ - CRC32校验             │
└──────────────────────────────────────┘

总计：32页 × 2KB = 64KB
```

## 资源限制

### Flash空间管理

**当前代码大小估算：**
```
├─ HAL库: ~20KB
├─ Modbus协议栈: ~8KB
├─ 驱动模块: ~10KB
├─ 应用代码: ~5KB
├─ 常量数据: ~2KB
└─ 预留: ~15KB
──────────────────
   合计: ~60KB ✓ (还剩4KB余量)
```

**如果代码超过60KB：**
- ⚠️ 会覆盖配置区/日志区
- ⚠️ 系统无法正常工作
- 🔧 解决：优化代码或升级芯片

### RAM空间管理

**C8T6只有20KB RAM！**

当前使用估算：
```
├─ HAL库: ~2KB
├─ Modbus缓冲区: ~2KB
├─ 传感器数据: ~1KB
├─ 堆栈: ~4KB
├─ 数组/缓冲区: ~6KB
└─ 预留: ~5KB
──────────────────
   合计: ~20KB (接近极限！)
```

**注意：**
- ❌ 不要随意增大缓冲区
- ❌ 避免大数组定义
- ✓ 尽量使用栈变量
- ✓ 监控堆栈溢出

## 功能限制

### 1. 错误日志条数

| 芯片 | 日志页大小 | 单条大小 | 最大条数 |
|------|----------|----------|----------|
| C8T6 | 2KB | 32B | **62条** |
| VCT6 | 2KB | 32B | 100条 |

**影响：**
- C8T6只能存储最近62条错误日志
- 超过后会循环覆盖（FIFO）

### 2. 代码优化建议

为了适应C8T6的限制：

**① 移除未使用的HAL模块**

检查 `stm32f1xx_hal_conf.h`，禁用不用的模块：
```c
// 如果不用CAN
/*#define HAL_CAN_MODULE_ENABLED*/

// 如果不用I2C
/*#define HAL_I2C_MODULE_ENABLED*/
```

**② 优化编译选项**

Keil编译器设置：
- Optimization Level: `-O2` 或 `-Os` (代码大小优化)
- Link Time Optimization: 启用

**③ 精简测试代码**

建议删除或条件编译测试代码：
```c
#ifdef DEBUG_MODE
    // 测试代码只在调试时编译
#endif
```

## 已知问题和解决方案

### 问题1：初始化卡住 ✅ 已解决

**原因：** 访问错误的Flash地址 `0x0803F800`（超出C8T6范围）

**解决：** 修改为正确地址 `0x0800F800`

### 问题2：Flash操作导致复位

**原因：** 
- Flash擦除需要20-40ms，期间CPU挂起
- 外部看门狗期待500ms内喂狗
- 如果Flash操作过长可能触发复位

**解决方案：**
- 暂时禁用Flash操作（当前方案）
- 或在Flash操作前暂停看门狗

### 问题3：代码空间不足（未来可能）

**预防措施：**
- 定期检查编译后的`.map`文件
- 监控Flash使用率
- 关键时升级到CB（128KB）或RC（256KB）型号

## 升级路径

如果C8T6资源不足，推荐升级：

| 型号 | Flash | RAM | 引脚兼容 | 价格 |
|------|-------|-----|---------|------|
| C8T6 | 64KB | 20KB | ✓ 当前 | 低 |
| **CB**T6 | **128KB** | **20KB** | ✓ 引脚兼容！| 稍高 |
| **RC**T6 | 256KB | 48KB | ❌ 需重新设计PCB | 高 |

**推荐：CB**T6（引脚兼容，直接替换，Flash翻倍）

## 调试技巧

### 检查Flash使用情况

编译后查看 `lighting_ultra.map` 文件：

```
Total RO  Size (Code + RO Data)    xxxxx (  xx.xx kB)  ← Flash使用
Total RW  Size (RW Data + ZI Data)  xxxx (  xx.xx kB)  ← RAM使用
Total ROM Size (Code + RO Data + RW Data) xxxxx ( xx.xx kB)
```

**警告阈值：**
- Flash > 60KB → ⚠️ 接近极限
- Flash > 62KB → 🔴 会覆盖配置区
- RAM > 18KB → ⚠️ 接近极限

### 检查堆栈使用

在 `startup_stm32f10x_md.s` 中：
```asm
Stack_Size      EQU     0x00000400  ; 1KB栈（可能不够！）
Heap_Size       EQU     0x00000200  ; 512B堆
```

建议C8T6配置：
```asm
Stack_Size      EQU     0x00000800  ; 2KB栈（更安全）
Heap_Size       EQU     0x00000100  ; 256B堆（减少堆）
```

## 总结

✅ **Flash地址已修复为C8T6正确地址**
✅ **系统可以正常工作**
⚠️ **资源紧张，需注意代码大小**
💡 **建议未来升级到C8T6→CB**T6（引脚兼容，直接换芯片即可）

